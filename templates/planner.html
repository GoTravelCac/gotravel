{% extends "base.html" %}

{% block title %}Trip Planner - go.travel{% endblock %}
{% block description %}Create your perfect travel itinerary with AI. Enter your destination and preferences to get a personalized travel plan.{% endblock %}

{% block styles %}
/* Trip Planner Specific Styles */
.planner-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: var(--white);
    padding: 2rem 0;
    text-align: center;
}

.planner-header h1 {
    font-family: var(--font-heading);
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

.trip-form {
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    padding: 2rem;
    margin: 2rem 0;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-color);
}

.form-group input,
.form-group textarea,
.form-group select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #e5e7eb;
    border-radius: var(--border-radius);
    font-size: 1rem;
    transition: border-color 0.3s ease;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.currency-info {
    margin-top: 0.75rem;
    padding: 0.75rem 1rem;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-radius: 8px;
    border-left: 4px solid var(--accent-color);
    animation: slideDown 0.3s ease-out;
}

.currency-display {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    color: var(--text-light);
}

.currency-icon {
    font-size: 1.1rem;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.interests-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.interest-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.interest-item input[type="checkbox"] {
    width: auto;
}

.generate-btn {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: var(--white);
    border: none;
    padding: 1rem 2rem;
    font-size: 1.1rem;
    font-weight: 600;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: transform 0.3s ease;
    width: 100%;
}

.generate-btn:hover {
    transform: translateY(-2px);
}

.generate-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* Results Section */
.results-section {
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    padding: 2rem;
    margin-top: 2rem;
    display: none;
}

.results-section.show {
    display: block;
}

.results-header {
    border-bottom: 2px solid #e5e7eb;
    padding-bottom: 1rem;
    margin-bottom: 2rem;
}

.results-header h2 {
    color: var(--text-color);
    font-size: 1.75rem;
    margin-bottom: 0.5rem;
}

.trip-summary {
    color: var(--text-light);
    font-size: 1rem;
}

.itinerary-content {
    line-height: 1.8;
    color: var(--text-color);
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
}

.itinerary-content h3 {
    color: var(--primary-color);
    margin: 2rem 0 1rem 0;
    font-size: 1.4rem;
    padding: 0.75rem 1rem;
    background: linear-gradient(135deg, var(--primary-color)10, transparent);
    border-left: 4px solid var(--primary-color);
    border-radius: 0 8px 8px 0;
    font-weight: 600;
}

/* Commented out - no longer using detailed itinerary formatting
.itinerary-content .time-block {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 1rem;
    margin: 0.75rem 0;
    border-left: 3px solid var(--secondary-color);
}

.itinerary-content .activity {
    margin: 1rem 0;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 6px;
    border-left: 2px solid #cbd5e1;
}

.itinerary-content .location {
    color: var(--secondary-color);
    font-weight: 500;
    font-size: 0.95rem;
}

.itinerary-content .cost {
    color: #059669;
    font-weight: 500;
    background: #ecfdf5;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.9rem;
    display: inline-block;
    margin: 0.25rem 0;
}

.itinerary-content .tip {
    background: #fef3c7;
    border: 1px solid #fbbf24;
    padding: 0.75rem;
    border-radius: 6px;
    margin: 0.5rem 0;
    font-style: italic;
    color: #92400e;
}
*/

.formatted-itinerary {
    max-width: 100%;
    overflow-x: auto;
}

/* Simple Itinerary Styling */
.simple-itinerary {
    max-width: 100%;
    overflow-x: auto;
    line-height: 1.8;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    color: var(--text-color);
}

/* Simple Divider Lines */
.divider-line {
    border: none;
    border-top: 2px solid var(--primary-color);
    margin: 2rem 0 1rem 0;
    width: 100%;
}

/* Simple Headers */
.simple-itinerary h3 {
    color: var(--primary-color);
    font-size: 1.4rem;
    font-weight: 600;
    margin: 1rem 0 0.5rem 0;
}

.simple-itinerary h4 {
    color: var(--secondary-color);
    font-size: 1.2rem;
    font-weight: 500;
    margin: 0.75rem 0 0.5rem 0;
}

/* Simple Paragraphs */
.simple-itinerary p {
    margin: 0.5rem 0;
    line-height: 1.6;
}

/* Simple Strong Text */
.simple-itinerary strong {
    color: var(--primary-color);
    font-weight: 600;
}

/* Simple Links */
.simple-itinerary a {
    color: #3b82f6;
    text-decoration: none;
    font-weight: 500;
}

.simple-itinerary a:hover {
    color: #2563eb;
    text-decoration: underline;
}
    padding: 0.75rem 1rem;
    margin: 0.5rem 0;
    color: #1e40af;
    font-family: monospace;
    font-weight: 500;
}

/* Responsive Design */
@media (max-width: 768px) {
    .maps-actions {
        flex-direction: column;
    }
    
    .maps-btn, .directions-btn {
        justify-content: center;
    }
}

/* Removed all itinerary formatting CSS - using plain text display now */
/*
.section-separator {
    border-top: 3px solid #e5e7eb;
    margin: 3rem 0;
    height: 0;
    position: relative;
    clear: both;
    display: block;
    width: 100%;
    background: linear-gradient(to right, transparent, #e5e7eb, transparent);
}

.section-separator::before {
    content: '';
    position: absolute;
    top: -1px;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(to right, transparent, var(--primary-color), transparent);
}

.section-separator::after {
    content: '✨';
    position: absolute;
    top: -15px;
    left: 50%;
    transform: translateX(-50%);
    background: white;
    padding: 0 1.5rem;
    color: var(--primary-color);
    font-size: 1.4rem;
    border: 2px solid #e5e7eb;
    border-radius: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
*/

.itinerary-content p {
    margin: 0.75rem 0;
    line-height: 1.7;
}

.itinerary-content strong {
    color: var(--text-color);
    font-weight: 600;
}

.itinerary-content br + br {
    display: none;
}

.maps-link {
    display: inline-block;
    margin-left: 0.5rem;
    padding: 0.25rem 0.5rem;
    background: #3b82f6;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 500;
    transition: background-color 0.2s;
}

.maps-link:hover {
    background: #2563eb;
    color: white;
}

.safety-header {
    color: #dc2626 !important;
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    border-left: 4px solid #dc2626;
    margin: 2rem 0 1rem 0 !important;
    padding: 1rem !important;
    border-radius: 0 8px 8px 0;
}

.safety-warning {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    color: #92400e;
    padding: 0.75rem;
    border-radius: 6px;
    margin: 0.5rem 0;
    font-weight: 500;
}

.emergency-contact {
    background: #fee2e2;
    border: 1px solid #dc2626;
    color: #991b1b;
    padding: 0.75rem;
    border-radius: 6px;
    margin: 0.5rem 0;
    font-weight: 500;
}

/* Enhanced Loading Animation */
.loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 2rem;
    padding: 4rem 2rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    margin: 2rem 0;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    position: relative;
    overflow: hidden;
}

.loading::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    animation: shimmer 2s infinite;
}

.spinner-container {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
}

.spinner {
    width: 60px;
    height: 60px;
    position: relative;
}

.spinner::before,
.spinner::after {
    content: '';
    position: absolute;
    border-radius: 50%;
    animation: spin 1.5s linear infinite;
}

.spinner::before {
    width: 100%;
    height: 100%;
    border: 3px solid transparent;
    border-top: 3px solid #ffffff;
    border-right: 3px solid #ffffff;
}

.spinner::after {
    width: 80%;
    height: 80%;
    top: 10%;
    left: 10%;
    border: 3px solid transparent;
    border-bottom: 3px solid #ffffff70;
    border-left: 3px solid #ffffff70;
    animation: spin 1s linear infinite reverse;
}

.loading-dots {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}

.loading-dot {
    width: 8px;
    height: 8px;
    background: #ffffff80;
    border-radius: 50%;
    animation: bounce 1.4s infinite ease-in-out;
}

.loading-dot:nth-child(1) { animation-delay: -0.32s; }
.loading-dot:nth-child(2) { animation-delay: -0.16s; }
.loading-dot:nth-child(3) { animation-delay: 0s; }

.loading span {
    font-size: 1.3rem;
    color: #ffffff;
    font-weight: 600;
    text-align: center;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    animation: textPulse 3s ease-in-out infinite;
    letter-spacing: 0.5px;
}

.loading-progress {
    width: 200px;
    height: 4px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 2px;
    overflow: hidden;
    margin-top: 1rem;
}

.loading-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #ffffff, #ffffff80, #ffffff);
    border-radius: 2px;
    animation: progress 3s ease-in-out infinite;
}

.loading-travel-icons {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
    opacity: 0.8;
}

.travel-icon {
    font-size: 1.5rem;
    animation: float 2s ease-in-out infinite;
}

.travel-icon:nth-child(1) { animation-delay: 0s; }
.travel-icon:nth-child(2) { animation-delay: 0.3s; }
.travel-icon:nth-child(3) { animation-delay: 0.6s; }
.travel-icon:nth-child(4) { animation-delay: 0.9s; }

@keyframes shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes bounce {
    0%, 80%, 100% { 
        transform: scale(0.8);
        opacity: 0.5;
    }
    40% { 
        transform: scale(1.2);
        opacity: 1;
    }
}

@keyframes textPulse {
    0%, 100% { 
        opacity: 1;
        transform: translateY(0);
    }
    50% { 
        opacity: 0.8;
        transform: translateY(-2px);
    }
}

@keyframes progress {
    0% { 
        transform: translateX(-100%);
        opacity: 0;
    }
    50% {
        opacity: 1;
    }
    100% { 
        transform: translateX(200px);
        opacity: 0;
    }
}

@keyframes float {
    0%, 100% { 
        transform: translateY(0px);
    }
    50% { 
        transform: translateY(-10px);
    }
}

/* Location Preview */
.location-preview {
    background: linear-gradient(135deg, #f0f9ff 0%, #ecfdf5 100%);
    border: 2px solid var(--primary-color);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin: 1.5rem 0;
}

.location-map {
    background: var(--white);
    padding: 1rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
}

.location-map h5 {
    font-size: 1.1rem;
    margin-bottom: 1rem;
    color: var(--primary-color);
    text-align: center;
}

/* Itinerary Management */
.itinerary-management {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border: 2px solid var(--accent-color);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin: 2rem 0;
}

.management-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

.management-card {
    background: var(--white);
    padding: 1.5rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-md);
}

.management-card h4 {
    font-size: 1.2rem;
    margin-bottom: 1rem;
    color: var(--primary-color);
}

.management-card textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #e5e7eb;
    border-radius: var(--border-radius);
    margin-bottom: 1rem;
    resize: vertical;
}

.action-btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
    margin: 0.25rem;
}

.action-btn.primary {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: var(--white);
    width: 100%;
}

.action-btn.secondary {
    background: var(--background-color);
    color: var(--text-color);
    border: 1px solid #e5e7eb;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.action-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
}

/* Responsive */
@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .interests-grid {
        grid-template-columns: 1fr;
    }
    
    .management-grid {
        grid-template-columns: 1fr;
    }
    
    .action-buttons {
        grid-template-columns: 1fr;
    }
}
{% endblock %}

{% block content %}
<!-- Planner Header -->
<section class="planner-header">
    <div class="container">
        <h1>Trip Planner</h1>
        <p>Create your perfect travel itinerary with AI assistance</p>
    </div>
</section>

<div class="container">
    <!-- Trip Planning Form -->
    <form id="tripForm" class="trip-form">
        <div class="form-group">
            <label for="destination">🌍 Where do you want to go?</label>
            <div class="destination-input-container">
                <input type="text" id="destination" name="destination" placeholder="Enter destination: city, country, or region (e.g., Paris, France or Japan)" autocomplete="off" required>
                <div id="currencyInfo" class="currency-info" style="display: none;">
                    <div class="currency-display">
                        <span class="currency-icon">💱</span>
                        <span id="currencyText">Local currency information will appear here</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="startDate">📅 Start Date</label>
                <input type="date" id="startDate" name="startDate" required>
            </div>
            <div class="form-group">
                <label for="endDate">📅 End Date</label>
                <input type="date" id="endDate" name="endDate" required>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="people">👥 Number of People</label>
                <input type="number" id="people" name="people" min="1" max="20" value="1" required>
            </div>
            <div class="form-group">
                <label for="children">👶 Number of Children</label>
                <input type="number" id="children" name="children" min="0" max="0" value="0">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="budget">💰 Budget Level</label>
                <select id="budget" name="budget" required>
                    <option value="">Select budget range</option>
                    <option value="budget">💵 Budget-friendly</option>
                    <option value="moderate">💸 Moderate</option>
                    <option value="luxury">💎 Luxury</option>
                </select>
            </div>
            <div class="form-group">
                <label for="lodging">🏨 Lodging Type</label>
                <select id="lodging" name="lodging" required>
                    <option value="">Select lodging type</option>
                    <option value="hotel">🏨 Hotel</option>
                    <option value="airbnb">🏠 Airbnb/Vacation Rental</option>
                    <option value="resort">🏖️ Resort</option>
                    <option value="hostel">🛏️ Hostel</option>
                    <option value="already_booked">✅ Already Booked</option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="travelTransport">✈️ Travel Transportation</label>
                <select id="travelTransport" name="travelTransport" required>
                    <option value="">How are you getting there?</option>
                    <option value="plane">✈️ Airplane</option>
                    <option value="drive">🚗 Driving</option>
                    <option value="train">🚂 Train</option>
                    <option value="bus">🚌 Bus</option>
                    <option value="cruise">🚢 Cruise</option>
                    <option value="other">🚀 Other</option>
                </select>
            </div>
            <div class="form-group">
                <label for="localTransport">🚗 Local Transportation</label>
                <select id="localTransport" name="localTransport" required>
                    <option value="">Local transportation preference</option>
                    <option value="rental_car">🚗 Rental Car</option>
                    <option value="own_car">🚙 Own Car</option>
                    <option value="rideshare">🚕 Rideshare/Taxi</option>
                    <option value="public_transport">🚇 Public Transportation</option>
                    <option value="walking">🚶 Walking</option>
                    <option value="bike">🚲 Bike/Scooter</option>
                    <option value="mix">🔄 Mix of Options</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label>🎨 Interests (select all that apply)</label>
            <div class="interests-grid">
                <div class="interest-item">
                    <input type="checkbox" id="museums" name="interests" value="museums">
                    <label for="museums">🏛️ Museums</label>
                </div>
                <div class="interest-item">
                    <input type="checkbox" id="food" name="interests" value="food">
                    <label for="food">🍽️ Local Food</label>
                </div>
                <div class="interest-item">
                    <input type="checkbox" id="shopping" name="interests" value="shopping">
                    <label for="shopping">🛍️ Shopping</label>
                </div>
                <div class="interest-item">
                    <input type="checkbox" id="nightlife" name="interests" value="nightlife">
                    <label for="nightlife">🌃 Nightlife</label>
                </div>
                <div class="interest-item">
                    <input type="checkbox" id="nature" name="interests" value="nature">
                    <label for="nature">🌿 Nature</label>
                </div>
                <div class="interest-item">
                    <input type="checkbox" id="architecture" name="interests" value="architecture">
                    <label for="architecture">🏗️ Architecture</label>
                </div>
                <div class="interest-item">
                    <input type="checkbox" id="beaches" name="interests" value="beaches">
                    <label for="beaches">🏖️ Beaches</label>
                </div>
                <div class="interest-item">
                    <input type="checkbox" id="sports" name="interests" value="sports">
                    <label for="sports">⚽ Sports</label>
                </div>
                <div class="interest-item">
                    <input type="checkbox" id="wellness" name="interests" value="wellness">
                    <label for="wellness">🧘 Wellness & Relaxation</label>
                </div>
                <div class="interest-item">
                    <input type="checkbox" id="adventure" name="interests" value="adventure">
                    <label for="adventure">🏔️ Adventure & Outdoors</label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="specialRequests">📝 Special Requests (optional)</label>
            <textarea id="specialRequests" name="specialRequests" rows="3" placeholder="Any specific requirements, accessibility needs, safety preferences, or special interests..."></textarea>
        </div>

        <button type="submit" class="generate-btn" id="generateBtn">
            ✨ Generate My Perfect Itinerary
        </button>
    </form>

    <!-- Location Preview (shown when destination is entered) -->
    <div id="locationPreview" class="location-preview" style="display: none;">
        <div class="location-map">
            <h5>📍 Location Preview</h5>
            <div id="location-map" style="height: 300px; border-radius: 8px;"></div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="results" class="results-section">
        <div class="results-header">
            <h2 id="resultTitle">Your Personalized Itinerary</h2>
            <div class="trip-summary" id="tripSummary"></div>
        </div>
        <div id="itineraryContent" class="itinerary-content"></div>
        
        <!-- Itinerary Management Section -->
        <div id="itineraryManagement" class="itinerary-management" style="display: none;">
            <h3 style="text-align: center; margin-bottom: 1.5rem; color: var(--primary-color);">✏️ Manage Your Itinerary</h3>
            <div class="management-grid">
                <div class="management-card">
                    <h4>🔄 Refine Your Itinerary</h4>
                    <textarea id="itinerary-changes" placeholder="Describe any changes you'd like to make to your plan..." rows="4"></textarea>
                    <button class="action-btn primary" onclick="refineItinerary()">Update Itinerary</button>
                </div>
                <div class="management-card">
                    <h4>📤 Export</h4>
                    <div class="action-buttons">
                        <button class="action-btn secondary" onclick="downloadText()">📄 Download</button>
                        <button class="action-btn secondary" onclick="copyItinerary()">📋 Copy</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
// Configuration
const CONFIG = {
    BACKEND_URL: '',  // Use relative URLs for same-origin requests
    GOOGLE_MAPS_API_KEY: '{{ google_api_key }}'
};

// Global variables
let map;
let autocomplete;
let currentItinerary = '';
let currentDestination = '';

// Utility function for safe URL parameter handling
function getDestinationFromURL() {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const destination = urlParams.get('destination');
        
        if (!destination) return null;
        
        // Try to decode the parameter, handling various encoding scenarios
        let decodedDestination = destination;
        
        // If it's already encoded, decode it
        if (destination.includes('%')) {
            try {
                decodedDestination = decodeURIComponent(destination);
            } catch (e) {
                console.warn('Could not decode destination parameter:', e);
                decodedDestination = destination;
            }
        }
        
        // Clean up the destination string
        decodedDestination = decodedDestination.trim();
        
        // Validate that the destination is not empty after processing
        if (decodedDestination.length === 0) {
            console.warn('Destination parameter is empty after processing');
            return null;
        }
        
        return decodedDestination;
    } catch (error) {
        console.error('Error processing URL parameters:', error);
        return null;
    }
}

// Initialize page when Google Maps API is ready
function initializePage() {
    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            initializeComponents();
        });
    } else {
        initializeComponents();
    }
}

function initializeComponents() {
    initializeAutocomplete();
    setupDateCalculation();
    
    // Check if destination is pre-filled from URL params
    const destination = getDestinationFromURL();
    if (destination) {
        const destinationInput = document.getElementById('destination');
        if (destinationInput) {
            destinationInput.value = destination;
            loadLocationInfo(destination);
            console.log('Successfully loaded destination from URL:', destination);
        }
    }
}

// Make sure initializePage is available globally for Google Maps callback
window.initializePage = initializePage;

// Setup date validation
function setupDateCalculation() {
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    
    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    startDateInput.min = today;
    endDateInput.min = today;
    
    startDateInput.addEventListener('change', function() {
        // Update end date minimum to start date
        endDateInput.min = this.value;
        if (endDateInput.value && endDateInput.value < this.value) {
            endDateInput.value = this.value;
        }
    });
}

// Initialize autocomplete
function initializeAutocomplete() {
    const input = document.getElementById('destination');
    
    if (input && typeof google !== 'undefined' && google.maps && google.maps.places) {
        try {
            // Use the original Autocomplete with expanded search options
            autocomplete = new google.maps.places.Autocomplete(input, {
                types: ['(regions)'], // This includes cities, countries, states, provinces, etc.
                fields: ['place_id', 'geometry', 'name', 'formatted_address', 'types', 'address_components'],
                strictBounds: false, // Don't restrict to viewport
                bounds: null // Remove location bias completely
            });

            // Remove any location bias for global search
            autocomplete.setBounds(null);

            autocomplete.addListener('place_changed', function() {
                const place = autocomplete.getPlace();
                if (place.geometry || place.name) {
                    // Use formatted_address if available, otherwise use name
                    const location = place.formatted_address || place.name;
                    loadLocationInfo(location);
                    
                    // Update currency info if the function exists
                    if (typeof updateCurrencyInfo === 'function') {
                        clearTimeout(window.currencyTimeout);
                        window.currencyTimeout = setTimeout(() => {
                            updateCurrencyInfo(location);
                        }, 500);
                    }
                }
            });
        } catch (error) {
            console.error('Error creating autocomplete:', error);
            console.log('Falling back to cities-only autocomplete');
            
            // Fallback to basic cities autocomplete
            try {
                autocomplete = new google.maps.places.Autocomplete(input, {
                    types: ['(cities)'],
                    fields: ['place_id', 'geometry', 'name', 'formatted_address'],
                    bounds: null
                });
                
                autocomplete.setBounds(null);
                
                autocomplete.addListener('place_changed', function() {
                    const place = autocomplete.getPlace();
                    if (place.geometry || place.name) {
                        const location = place.formatted_address || place.name;
                        loadLocationInfo(location);
                    }
                });
            } catch (fallbackError) {
                console.error('Fallback autocomplete also failed:', fallbackError);
            }
        }
    }
}

// Load location information
async function loadLocationInfo(location) {
    try {
        const response = await fetch(`${CONFIG.BACKEND_URL}/api/location-info`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ location: location })
        });

        if (response.ok) {
            const data = await response.json();
            displayLocationInfo(data);
        }
    } catch (error) {
        console.error('Error loading location info:', error);
    }
}

// Display location information
function displayLocationInfo(data) {
    if (!data || data.error) return;

    const preview = document.getElementById('locationPreview');
    
    // Show the preview (just the map)
    preview.style.display = 'block';
    
    // Create map if coordinates available
    if (data.location?.coordinates) {
        createInteractiveMap(
            data.location.coordinates.lat,
            data.location.coordinates.lng,
            data.location.address
        );
    }
}

// Create interactive map
function createInteractiveMap(lat, lng, title) {
    const mapContainer = document.getElementById('location-map');
    if (!mapContainer) return;
    
    // Check if Google Maps is available
    if (!google || !google.maps) {
        console.warn('Google Maps not available - hiding map container');
        mapContainer.style.display = 'none';
        return;
    }

    try {
        const mapOptions = {
            center: { lat: lat, lng: lng },
            zoom: 13,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };

        map = new google.maps.Map(mapContainer, mapOptions);
    } catch (error) {
        console.error('Error creating map:', error);
        mapContainer.style.display = 'none';
        return;
    }

    let marker;
    
    // Use the new AdvancedMarkerElement if available, fallback to deprecated Marker
    try {
        if (google.maps.marker && google.maps.marker.AdvancedMarkerElement) {
            marker = new google.maps.marker.AdvancedMarkerElement({
                position: { lat: lat, lng: lng },
                map: map,
                title: title
            });
        } else {
            // Fallback to deprecated Marker for compatibility
            marker = new google.maps.Marker({
                position: { lat: lat, lng: lng },
                map: map,
                title: title
            });
        }
    } catch (error) {
        console.warn('Error creating marker, falling back to deprecated Marker:', error);
        marker = new google.maps.Marker({
            position: { lat: lat, lng: lng },
            map: map,
            title: title
        });
    }

    const infoWindow = new google.maps.InfoWindow({
        content: `<div style="padding: 5px;"><strong>${title}</strong></div>`
    });

    marker.addListener('click', function() {
        infoWindow.open(map, marker);
    });
}

// Enhanced loading HTML generator with dynamic messaging
function createEnhancedLoading(initialMessage) {
    return `
        <div class="loading">
            <div class="spinner-container">
                <div class="spinner"></div>
            </div>
            <span id="loading-message">${initialMessage}</span>
            <div class="loading-dots">
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            </div>
            <div class="loading-progress">
                <div class="loading-progress-bar"></div>
            </div>
            <div class="loading-travel-icons">
                <div class="travel-icon">✈️</div>
                <div class="travel-icon">🗺️</div>
                <div class="travel-icon">🏨</div>
                <div class="travel-icon">🎒</div>
            </div>
        </div>
    `;
}

// Dynamic loading messages
function startLoadingMessages(isUpdate = false) {
    const messages = isUpdate ? [
        'Updating your itinerary...',
        'Applying your changes...',
        'Optimizing your travel plan...',
        'Finalizing your perfect trip...'
    ] : [
        'Creating your perfect itinerary...',
        'This usually takes 2-3 minutes...',
        'Analyzing the best destinations...',
        'Finding amazing restaurants...',
        'Calculating optimal routes...',
        'Adding local insider tips...',
        'Almost ready - finalizing your adventure...'
    ];
    
    let messageIndex = 0;
    const messageElement = document.getElementById('loading-message');
    
    if (messageElement) {
        const interval = setInterval(() => {
            messageIndex = (messageIndex + 1) % messages.length;
            if (messageElement) {
                messageElement.style.opacity = '0';
                setTimeout(() => {
                    if (messageElement) {
                        messageElement.textContent = messages[messageIndex];
                        messageElement.style.opacity = '1';
                    }
                }, 300);
            }
        }, 2500);
        
        // Store interval for cleanup
        window.loadingMessageInterval = interval;
    }
}

// Stop loading messages
function stopLoadingMessages() {
    if (window.loadingMessageInterval) {
        clearInterval(window.loadingMessageInterval);
        window.loadingMessageInterval = null;
    }
}

// Browser notification function
function showNotification(title, message, options = {}) {
    // Check if notifications are supported
    if (!("Notification" in window)) {
        console.log("This browser does not support notifications");
        return;
    }
    
    // Check permission status
    if (Notification.permission === "granted") {
        new Notification(title, {
            body: message,
            icon: '/favicon/favicon-96x96.png',
            badge: '/favicon/favicon-96x96.png',
            ...options
        });
    } else if (Notification.permission !== "denied") {
        // Request permission
        Notification.requestPermission().then(permission => {
            if (permission === "granted") {
                new Notification(title, {
                    body: message,
                    icon: '/favicon/favicon-96x96.png',
                    badge: '/favicon/favicon-96x96.png',
                    ...options
                });
            }
        });
    }
}

// Form submission
document.getElementById('tripForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const destination = formData.get('destination');
    const startDate = formData.get('startDate');
    const endDate = formData.get('endDate');
    const people = formData.get('people');
    const budget = formData.get('budget');
    const specialRequests = formData.get('specialRequests');
    
    // Collect interests
    const interests = [];
    document.querySelectorAll('input[name="interests"]:checked').forEach(cb => {
        interests.push(cb.value);
    });
    
    if (!destination || !startDate || !endDate || !people || !budget) {
        showMessage('Please fill in all required fields.', 'error');
        return;
    }
    
    if (parseInt(people) < 1) {
        showMessage('Please enter a valid number of people (at least 1).', 'error');
        return;
    }
    
    // Calculate duration from dates
    const start = new Date(startDate);
    const end = new Date(endDate);
    const timeDifference = end.getTime() - start.getTime();
    const duration = Math.ceil(timeDifference / (1000 * 3600 * 24)) + 1;
    
    // Request notification permission if not already granted
    if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission();
    }
    
    // Show initial time estimate message
    showMessage('⏱️ Starting itinerary generation... This typically takes 2-3 minutes.', 'info');
    
    // Show loading
    const generateBtn = document.getElementById('generateBtn');
    
    // Disable form and button during generation
    generateBtn.disabled = true;
    generateBtn.textContent = 'Generating...';
    
    const resultsSection = document.getElementById('results');
    const itineraryContent = document.getElementById('itineraryContent');
    
    resultsSection.classList.add('show');
    document.getElementById('resultTitle').textContent = `Your ${destination} Itinerary`;
    document.getElementById('tripSummary').textContent = `${duration} days • ${people} ${people == 1 ? 'person' : 'people'} • ${budget} budget • ${startDate} to ${endDate}`;
    
    itineraryContent.innerHTML = createEnhancedLoading('Creating your perfect itinerary...');
    
    // Start dynamic loading messages
    setTimeout(() => startLoadingMessages(false), 500);
    
    try {
        const response = await fetch(`${CONFIG.BACKEND_URL}/api/generate-itinerary`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                destination,
                start_date: startDate,
                end_date: endDate,
                duration: parseInt(duration),
                people: parseInt(people),
                budget,
                interests,
                special_requests: specialRequests
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                currentDestination = destination;
                
                // Debug: Log the raw itinerary content
                console.log('Raw itinerary received:', data.itinerary ? data.itinerary.substring(0, 200) + '...' : 'EMPTY');
                
                // Check if itinerary content exists
                if (!data.itinerary || data.itinerary.trim() === '') {
                    throw new Error('Empty itinerary received from server');
                }
                
                // Format itinerary with location information
                let fullItinerary = formatItinerary(data.itinerary);
                if (data.location_info) {
                    fullItinerary = addLocationInfoToItinerary(data.location_info) + fullItinerary;
                }
                
                // Debug: Log the formatted content
                console.log('Formatted itinerary length:', fullItinerary.length);
                
                itineraryContent.innerHTML = fullItinerary;
                
                // Show management section
                document.getElementById('itineraryManagement').style.display = 'block';
                
                // Show success message and notification
                showMessage('🎉 Your itinerary is ready!', 'success');
                showNotification('🎉 Itinerary Complete!', `Your ${destination} travel plan is ready to explore!`, {
                    tag: 'itinerary-complete',
                    requireInteraction: true
                });
                
                // Auto-scroll to results section after success notification is visible
                setTimeout(() => {
                    const resultsSection = document.getElementById('results');
                    if (resultsSection) {
                        resultsSection.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start',
                            inline: 'nearest'
                        });
                    }
                }, 800); // Reduced delay - scroll right after message appears
            } else {
                throw new Error(data.error || 'Failed to generate itinerary');
            }
        } else {
            throw new Error('Server error');
        }
    } catch (error) {
        console.error('Error:', error);
        itineraryContent.innerHTML = '';
        showMessage('Error generating itinerary. Please try again.', 'error');
    } finally {
        // Stop loading messages and restore button state
        stopLoadingMessages();
        generateBtn.disabled = false;
        generateBtn.textContent = 'Generate My Itinerary';
    }
});

// Add location information to itinerary
function addLocationInfoToItinerary(data) {
    if (!data || data.error) return '';
    
    let locationHTML = '<div style="background: linear-gradient(135deg, #f0f9ff 0%, #ecfdf5 100%); border: 2px solid var(--primary-color); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">';
    locationHTML += '<h3 style="color: var(--primary-color); margin-bottom: 1rem;">📍 Destination Information</h3>';
    locationHTML += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">';
    
    if (data.location) {
        locationHTML += `
            <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <h5 style="color: var(--primary-color); margin-bottom: 0.5rem;">📍 Location</h5>
                <p style="color: var(--text-light);">${data.location.address}</p>
            </div>
        `;
    }
    
    if (data.weather) {
        const weather = data.weather;
        locationHTML += `
            <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <h5 style="color: var(--primary-color); margin-bottom: 0.5rem;">🌤️ Current Weather</h5>
                <p style="color: var(--text-light);">${Math.round(weather.main?.temp || 0)}°C - ${weather.weather?.[0]?.description || 'N/A'}</p>
            </div>
        `;
    }
    
    if (data.timezone) {
        const timezone = data.timezone;
        const localTime = new Date().toLocaleString('en-US', {
            timeZone: timezone.timeZoneId,
            timeZoneName: 'short'
        });
        locationHTML += `
            <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <h5 style="color: var(--primary-color); margin-bottom: 0.5rem;">🕒 Local Time</h5>
                <p style="color: var(--text-light);">${localTime}</p>
            </div>
        `;
    }
    
    locationHTML += '</div></div>';
    return locationHTML;
}

// Format itinerary
function formatItinerary(itinerary) {
    currentItinerary = itinerary;
    
    if (!itinerary || itinerary.trim() === '') {
        return '<div class="simple-itinerary"><p>No itinerary content available.</p></div>';
    }
    
    try {
        // Simple formatting with divider lines instead of sections
        let formatted = itinerary
            // First, handle markdown bold formatting properly
            .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
            // Remove remaining single asterisks and hash marks
            .replace(/#{1,6}\s*/g, '') 
            .replace(/\*/g, '')
            
            // Add divider lines before major sections (but preserve content)
            .replace(/^(Day \d+:)/gm, '<hr class="divider-line"><h3>📅 $1</h3>')
            .replace(/^(Morning|Afternoon|Evening|Lunch|Dinner|Breakfast)(\s*\([^)]+\))?:/gm, '<hr class="divider-line"><h4>🕐 $1$2:</h4>')
            
            // Add divider before major sections
            .replace(/(SAFETY INFORMATION|Cultural Considerations|Money and Document Safety|Emergency Contacts|CURRENCY|BUDGET)/gi, '<hr class="divider-line"><h3>🛡️ $1</h3>')
            
            // Format addresses with simple styling
            .replace(/Address:\s*([^\n]+)/g, function(match, address) {
                const cleanAddress = address.trim();
                if (!cleanAddress) return match;
                const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(cleanAddress)}`;
                return `<hr class="divider-line"><p><strong>📍 Address:</strong> ${cleanAddress}</p>
                        <p><a href="${mapsUrl}" target="_blank" style="color: #3b82f6; text-decoration: none;">🗺️ View on Maps</a> | 
                        <a href="https://www.google.com/maps/dir//${encodeURIComponent(cleanAddress)}" target="_blank" style="color: #3b82f6; text-decoration: none;">🧭 Get Directions</a></p>`;
            })
            
            // Format costs with simple styling - improved pattern
            .replace(/(?:Estimated cost|Cost|Price)(?:\s*for \d+ people?)?:\s*([^\n]+)/gi, '<hr class="divider-line"><p><strong>💰 Cost:</strong> $1</p>')
            
            // Format tips with simple styling
            .replace(/(?:Local Tip|Tip|Cultural Insight):\s*([^\n]+)/gi, '<hr class="divider-line"><p><strong>💡 Tip:</strong> $1</p>')
            
            // Format warnings with simple styling
            .replace(/(?:Safety Warning|Warning|Caution):\s*([^\n]+)/gi, '<hr class="divider-line"><p><strong>⚠️ Warning:</strong> $1</p>')
            
            // Format emergency contacts with simple styling
            .replace(/(?:Emergency|Police|Medical|Tourist Help):\s*([^\n]+)/gi, '<hr class="divider-line"><p><strong>📞 Emergency:</strong> $1</p>')
            
            // Format bullet points more carefully - only match actual bullet points
            .replace(/^[\s]*[-•]\s*([^\n]+)/gm, '<p>• $1</p>')
            
            // Handle multiple consecutive line breaks first
            .replace(/\n{3,}/g, '\n\n')
            // Then handle double line breaks
            .replace(/\n\n+/g, '<br><br>')
            // Finally handle single line breaks
            .replace(/\n/g, '<br>');
        
        // Clean up any empty paragraphs or broken HTML
        formatted = formatted
            .replace(/<p>\s*<\/p>/g, '')
            .replace(/<br>\s*<br>\s*<br>/g, '<br><br>')
            .replace(/^\s*<br>/, '')
            .replace(/<br>\s*$/g, '');
        
        // Ensure we still have content after formatting
        if (!formatted || formatted.trim() === '') {
            console.warn('Formatting resulted in empty content, using fallback');
            return `<div class="simple-itinerary"><pre style="white-space: pre-wrap; font-family: inherit;">${itinerary}</pre></div>`;
        }
        
        return `<div class="simple-itinerary">${formatted}</div>`;
        
    } catch (error) {
        console.error('Error formatting itinerary:', error);
        // Fallback to basic formatting if regex fails
        const fallback = itinerary
            .replace(/\n/g, '<br>')
            .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
        return `<div class="simple-itinerary">${fallback}</div>`;
    }
}

// Itinerary management functions
async function refineItinerary() {
    const changes = document.getElementById('itinerary-changes').value.trim();
    if (!changes || !currentItinerary || !currentDestination) {
        showMessage('Please enter your requested changes.', 'error');
        return;
    }

    // Show loading state - hide current itinerary and show spinner
    const itineraryContent = document.getElementById('itineraryContent');
    const updateBtn = document.querySelector('button[onclick="refineItinerary()"]');
    
    // Hide current itinerary and show loading
    itineraryContent.innerHTML = createEnhancedLoading('Updating your itinerary...');
    
    // Start dynamic loading messages for update
    setTimeout(() => startLoadingMessages(true), 500);
    
    // Disable the update button
    updateBtn.disabled = true;
    updateBtn.textContent = 'Updating...';
    
    try {
        const response = await fetch(`${CONFIG.BACKEND_URL}/api/refine-itinerary`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                current_itinerary: currentItinerary,
                feedback: changes,
                destination: currentDestination
            })
        });

        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                // Update the display
                document.getElementById('itineraryContent').innerHTML = formatItinerary(data.itinerary);
                // Update the current itinerary variable for future operations
                currentItinerary = data.itinerary;
                document.getElementById('itinerary-changes').value = '';
                showMessage('Itinerary updated successfully!', 'success');
                
                // Auto-scroll to show the updated itinerary
                setTimeout(() => {
                    const resultsSection = document.getElementById('results');
                    if (resultsSection) {
                        resultsSection.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                    }
                }, 500);
            } else {
                throw new Error(data.error || 'Failed to refine itinerary');
            }
        } else {
            throw new Error('Server error');
        }
    } catch (error) {
        console.error('Error refining itinerary:', error);
        showMessage('Error updating itinerary. Please try again.', 'error');
        // Restore original itinerary on error
        document.getElementById('itineraryContent').innerHTML = formatItinerary(currentItinerary);
    } finally {
        // Always restore button state
        updateBtn.disabled = false;
        updateBtn.textContent = 'Update Itinerary';
        
        // Stop loading animation if it's active
        stopLoadingMessages();
    }
}

// Helper function to convert HTML itinerary to clean plain text
function getPlainTextItinerary() {
    if (!currentItinerary) {

        return '';
    }
    
    // Create a temporary div to convert HTML to plain text
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = currentItinerary;
    
    // Convert HTML to clean plain text
    let plainText = tempDiv.textContent || tempDiv.innerText || '';
    
    // Additional formatting for better readability
    plainText = plainText
        // Clean up excessive whitespace
        .replace(/\s+/g, ' ')
        .replace(/\n\s+/g, '\n')
        // Add proper spacing around day headers
        .replace(/(Day\s+\d+[:\s]*[^\n]*)/gi, '\n\n📅 $1\n')
        // Add spacing around time periods
        .replace(/(Morning|Afternoon|Evening|Night)[:\s]*([^\n]*)/gi, '\n🕐 $1: $2\n')
        // Format safety information header
        .replace(/(SAFETY INFORMATION)/gi, '\n\n🛡️ $1\n' + '─'.repeat(30) + '\n')
        // Format bullet points
        .replace(/—\s*/g, '\n• ')
        .replace(/•\s*/g, '\n  • ')
        // Add spacing before addresses
        .replace(/(📍[^\n]+)/g, '\n    $1')
        // Add spacing before costs
        .replace(/(💰[^\n]+)/g, '\n    $1')
        // Add spacing before tips
        .replace(/(💡[^\n]+)/g, '\n    $1')
        // Clean up multiple newlines
        .replace(/\n{4,}/g, '\n\n\n')
        .replace(/\n{3}/g, '\n\n')
        .trim();
    
    // Add header info if available
    const headerInfo = `🌍 TRAVEL ITINERARY\n${currentDestination ? `📍 Destination: ${currentDestination}` : ''}\n${currentItinerary.includes('duration') ? '' : ''}\n${'='.repeat(50)}\n\n`;
    
    const finalText = headerInfo + plainText + '\n\n' + '='.repeat(50) + '\n✨ Generated by go.travel - AI Travel Planner\n🌐 https://gotravel-ai-407949658262.us-central1.run.app';
    

    return finalText;
}

// Enhanced formatting function for export
function getFormattedItineraryForExport() {
    if (!currentItinerary) return '';
    
    const exportDate = new Date().toLocaleDateString('en-US', { 
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
    });
    
    // Better HTML to text conversion that preserves structure
    let text = currentItinerary
        .replace(/<h3[^>]*>/gi, '\n\n📅 ')
        .replace(/<h3 class="safety-header"[^>]*>/gi, '\n\n🛡️ ')
        .replace(/<\/h3>/gi, '\n' + '─'.repeat(40))
        .replace(/<div class="time-block"[^>]*><strong[^>]*>/gi, '\n\n🕐 ')
        .replace(/<\/strong><\/div>/gi, '\n')
        .replace(/<div class="activity"[^>]*><strong[^>]*>/gi, '\n  • ')
        .replace(/<\/strong><br><\/div>/gi, '')
        .replace(/<div class="location"[^>]*>/gi, '\n    📍 ')
        .replace(/<a href="[^"]*" target="_blank" class="maps-link"[^>]*>🗺️ View on Maps<\/a>/gi, '')
        .replace(/<div class="cost"[^>]*>/gi, '\n    💰 ')
        .replace(/<div class="tip"[^>]*>/gi, '\n    💡 ')
        .replace(/<div class="safety-warning"[^>]*>/gi, '\n    ⚠️ ')
        .replace(/<div class="emergency-contact"[^>]*>/gi, '\n    🚨 ')
        .replace(/<\/div>/gi, '')
        .replace(/<br\s*\/?>/gi, '\n')
        .replace(/<[^>]+>/g, '')
        .replace(/\n\s*\n\s*\n/g, '\n\n')
        .replace(/^\s+|\s+$/gm, '')
        .replace(/\n{3,}/g, '\n\n')
        .trim();
    
    const destination = currentDestination || 'Your Destination';
    const header = `🌍 TRAVEL ITINERARY FOR ${destination.toUpperCase()}\n${'═'.repeat(60)}\n📅 Generated: ${exportDate}\n✨ Created by go.travel AI Travel Planner\n${'═'.repeat(60)}\n`;
    const footer = `\n${'═'.repeat(60)}\n🌐 https://gotravel-app-407949658262.us-central1.run.app\n✨ Powered by Google Gemini 2.5 Flash AI`;
    
    return header + '\n' + text + footer;
}

function downloadText() {
    if (!currentItinerary) {
        showMessage('No itinerary to download. Please generate one first.', 'error');
        return;
    }
    

    
    const plainText = getFormattedItineraryForExport();
    
    if (!plainText || plainText.trim() === '') {
        showMessage('Unable to export itinerary. Please try generating a new one.', 'error');
        return;
    }
    
    try {
        const element = document.createElement('a');
        const file = new Blob([plainText], { type: 'text/plain;charset=utf-8' });
        element.href = URL.createObjectURL(file);
        
        // Create a safe filename
        const safeDestination = currentDestination ? 
            currentDestination.replace(/[^a-z0-9\s]/gi, '').replace(/\s+/g, '_') : 
            'itinerary';
        element.download = `${safeDestination}_itinerary.txt`;
        
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
        
        // Clean up the object URL
        setTimeout(() => URL.revokeObjectURL(element.href), 100);
        
        showMessage('Itinerary downloaded successfully!', 'success');
    } catch (error) {
        console.error('Download error:', error);
        showMessage('Error downloading itinerary. Please try again.', 'error');
    }
}

function copyItinerary() {
    if (!currentItinerary) {
        showMessage('No itinerary to copy. Please generate one first.', 'error');
        return;
    }
    
    const plainText = getFormattedItineraryForExport();
    
    if (!plainText || plainText.trim() === '') {
        showMessage('Unable to copy itinerary. Please try generating a new one.', 'error');
        return;
    }
    
    try {
        navigator.clipboard.writeText(plainText).then(() => {
            showMessage('Itinerary copied to clipboard!', 'success');
        }).catch(() => {
            showMessage('Unable to copy to clipboard. Please copy manually.', 'error');
        });
    } catch (error) {
        console.error('Copy error:', error);
        showMessage('Error copying itinerary. Please try again.', 'error');
    }
}

// Show message
function showMessage(message, type) {
    // Create message element
    const messageDiv = document.createElement('div');
    messageDiv.className = `${type}-message`;
    
    let backgroundColor;
    switch(type) {
        case 'success':
            backgroundColor = '#10b981';
            break;
        case 'error':
            backgroundColor = '#ef4444';
            break;
        case 'info':
            backgroundColor = '#3b82f6';
            break;
        default:
            backgroundColor = '#6b7280';
    }
    
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 1000;
        max-width: 300px;
        background: ${backgroundColor};
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    `;
    messageDiv.textContent = message;
    
    document.body.appendChild(messageDiv);
    
    // Remove after 3 seconds (or 2 seconds for info messages)
    const timeout = type === 'info' ? 2000 : 3000;
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
        }
    }, timeout);
}

// Validation for children not exceeding total people
function setupChildrenValidation() {
    const peopleInput = document.getElementById('people');
    const childrenInput = document.getElementById('children');
    
    function validateChildren() {
        const totalPeople = parseInt(peopleInput.value) || 0;
        const children = parseInt(childrenInput.value) || 0;
        
        // Update max attribute for children input
        childrenInput.max = totalPeople;
        
        // If children exceeds total people, set to max allowed
        if (children > totalPeople) {
            childrenInput.value = totalPeople;
        }
    }
    
    peopleInput.addEventListener('input', validateChildren);
    childrenInput.addEventListener('input', validateChildren);
    
    // Initial validation
    validateChildren();
}

// Setup currency information display
function setupCurrencyInfo() {
    const destinationInput = document.getElementById('destination');
    const currencyInfo = document.getElementById('currencyInfo');
    const currencyText = document.getElementById('currencyText');
    let currencyTimeout;
    
    if (!destinationInput || !currencyInfo || !currencyText) return;
    
    async function updateCurrencyInfo(destination) {
        if (!destination || destination.length < 3) {
            currencyInfo.style.display = 'none';
            return;
        }
        
        try {
            currencyText.textContent = 'Loading currency information...';
            currencyInfo.style.display = 'block';
            
            const response = await fetch(`${CONFIG.BACKEND_URL}/api/currency/${encodeURIComponent(destination)}`);
            const data = await response.json();
            
            if (data.success) {
                currencyText.textContent = `${data.local_currency} - ${data.formatted_rate}`;
                currencyInfo.style.display = 'block';
            } else {
                currencyInfo.style.display = 'none';
            }
        } catch (error) {
            console.error('Currency lookup error:', error);
            currencyInfo.style.display = 'none';
        }
    }
    
    destinationInput.addEventListener('input', function() {
        clearTimeout(currencyTimeout);
        const destination = this.value.trim();
        
        if (destination.length < 3) {
            currencyInfo.style.display = 'none';
            return;
        }
        
        // Debounce the currency lookup
        currencyTimeout = setTimeout(() => {
            updateCurrencyInfo(destination);
        }, 1000);
    });
    
    destinationInput.addEventListener('blur', function() {
        const destination = this.value.trim();
        if (destination.length >= 3) {
            clearTimeout(currencyTimeout);
            updateCurrencyInfo(destination);
        }
    });
}

// Fallback initialization for duration calculation if Google Maps fails
document.addEventListener('DOMContentLoaded', function() {
    // Setup children validation
    setupChildrenValidation();
    
    // Setup currency information display
    setupCurrencyInfo();
    
    // Add a small delay to allow Google Maps to load first
    setTimeout(function() {
        // If Google Maps hasn't initialized the date calculation, do it manually
        const durationInput = document.getElementById('duration');
        if (durationInput && durationInput.value === '0') {
            setupDateCalculation();
        }
        
        // If autocomplete hasn't been initialized, try again
        if (!autocomplete && typeof google !== 'undefined' && google.maps && google.maps.places) {
            initializeAutocomplete();
        }
    }, 2000);
    
    // Additional fallback with longer delay
    setTimeout(function() {
        if (!autocomplete && typeof google !== 'undefined' && google.maps && google.maps.places) {
            initializeAutocomplete();
        }
    }, 5000);
});
{% endblock %}